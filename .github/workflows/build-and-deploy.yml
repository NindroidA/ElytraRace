name: Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------
      # Checkout and Java Setup
      # ----------------------------------------------------
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0     # REQUIRED for creating and pushing tags

      - name: ‚òï Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin
          cache: maven

      # ----------------------------------------------------
      # Build JAR file
      # ----------------------------------------------------
      - name: üî® Build with Maven
        run: mvn -B clean package -DskipTests

      # ----------------------------------------------------
      # Detect JAR + version
      # ----------------------------------------------------
      - name: üì¶ Detect JAR + version
        id: jar
        run: |
          JAR=$(find target -name "ElytraRace-*.jar" | head -1)
          if [ -z "$JAR" ]; then
            echo "‚ùå JAR not found!"
            exit 1
          fi

          VERSION=$(echo "$JAR" | sed -E 's/.*ElytraRace-(.*)\.jar/\1/')

          echo "JAR_FILE=$JAR" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

          echo "Detected JAR: $JAR"
          echo "Version: $VERSION"

      # ----------------------------------------------------
      # Create tag (if missing)
      # ----------------------------------------------------
      - name: üè∑ Create Git Tag
        id: create_tag
        run: |
          TAG="v${{ steps.jar.outputs.VERSION }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch --tags

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists."
          else
            echo "Creating tag $TAG"
            git tag "$TAG"
            git push origin "$TAG"
            echo "CREATED_TAG=$TAG" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------
      # Prepare correct ref for GitHub Release
      # ----------------------------------------------------
      - name: üîß Force correct GITHUB_REF (fix release error)
        run: |
          TAG="v${{ steps.jar.outputs.VERSION }}"
          echo "REF=refs/tags/$TAG" >> $GITHUB_ENV
          echo "GITHUB_REF=refs/tags/$TAG" >> $GITHUB_ENV
          echo "GITHUB_REF_NAME=$TAG" >> $GITHUB_ENV
          echo "GITHUB_REF_TYPE=tag" >> $GITHUB_ENV

      # ----------------------------------------------------
      # GitHub Release
      # ----------------------------------------------------
      - name: üöÄ Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.jar.outputs.VERSION }}
          files: ${{ steps.jar.outputs.JAR_FILE }}
          name: ElytraRace v${{ steps.jar.outputs.VERSION }}
          body: |
            üöÄ **ElytraRace v${{ steps.jar.outputs.VERSION }} Released!**

            This release was automatically built from the main branch.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------
      # Modrinth Upload (optional)
      # ----------------------------------------------------
      - name: üîç Check Modrinth config
        id: modrinth_check
        run: |
          if [ -n "${{ secrets.MODRINTH_TOKEN }}" ] && [ -n "${{ vars.MODRINTH_PROJECT_ID }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
          fi

      - name: üì§ Upload to Modrinth
        if: steps.modrinth_check.outputs.configured == 'true'
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ vars.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          name: ElytraRace ${{ steps.jar.outputs.VERSION }}
          version: ${{ steps.jar.outputs.VERSION }}
          files: ${{ steps.jar.outputs.JAR_FILE }}
          version-type: release
          loaders: |
            paper
            spigot
            purpur
          game-versions: |
            1.21
            1.21.1
            1.21.2
            1.21.3
            1.21.4

      - name: ‚è≠ Skip Modrinth Upload
        if: steps.modrinth_check.outputs.configured == 'false'
        run: echo "Skipping Modrinth (not configured)"

      # ----------------------------------------------------
      # Spigot Upload (optional)
      # ----------------------------------------------------
      - name: üîç Check Spigot config
        id: spigot_check
        run: |
          if [ -n "${{ secrets.SPIGOT_TOKEN }}" ] && [ -n "${{ vars.SPIGOT_RESOURCE_ID }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
          fi

      - name: üì§ Upload to SpigotMC
        if: steps.spigot_check.outputs.configured == 'true'
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          spigot-id: ${{ vars.SPIGOT_RESOURCE_ID }}
          spigot-token: ${{ secrets.SPIGOT_TOKEN }}
          files: ${{ steps.jar.outputs.JAR_FILE }}
          name: ElytraRace ${{ steps.jar.outputs.VERSION }}
          version: ${{ steps.jar.outputs.VERSION }}

      - name: ‚è≠ Skip Spigot Upload
        if: steps.spigot_check.outputs.configured == 'false'
        run: echo "Skipping Spigot (not configured)"

      # ----------------------------------------------------
      # Done
      # ----------------------------------------------------
      - name: üéâ Finished
        run: echo "Build + Release + Modrinth + Spigot complete!"
